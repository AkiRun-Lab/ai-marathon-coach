# AIマラソンコーチ 仕様書

## 📋 概要

| 項目 | 内容 |
|:-----|:-----|
| アプリ名 | AIマラソンコーチ |
| バージョン | 1.0.0 |
| 目的 | ジャック・ダニエルズ理論に基づくマラソントレーニング計画の自動生成 |
| 技術スタック | Python, Streamlit, Google Gemini 3 API |
| 公開URL | https://ai-marathon-coach.streamlit.app/ |

---

## 🏗️ アーキテクチャ

```
ai-marathon-coach/
├── app.py                    # メインアプリケーション
├── src/
│   ├── config.py             # 設定値・判定関数
│   ├── data_loader.py        # CSVデータ読み込み
│   ├── vdot/
│   │   ├── calculator.py     # VDOT計算
│   │   ├── paces.py          # ペース計算
│   │   └── training.py       # トレーニング期間計算
│   ├── ai/
│   │   └── gemini_client.py  # Gemini API連携
│   └── ui/
│       ├── components.py     # UIコンポーネント
│       └── styles.css        # スタイルシート
├── data/
│   ├── vdot_list.csv         # VDOTマスターデータ
│   └── vdot_pace.csv         # ペースマスターデータ
├── tests/                    # ユニットテスト
└── .streamlit/
    └── secrets.toml          # APIキー（Git管理外）
```

---

## ⚙️ 設定値（src/config.py）

### 基本設定
| 定数名 | デフォルト値 | 説明 |
|:-------|:-------------|:-----|
| GEMINI_MODEL_NAME | gemini-3-flash-preview | 使用するGeminiモデル |
| GEMINI_TEMPERATURE | 0.7 | 生成の創造性（0〜2） |
| GEMINI_MAX_OUTPUT_TOKENS | 32768 | 最大出力トークン数 |
| MIN_TRAINING_WEEKS | 12 | 最低トレーニング期間 |
| NUM_PHASES | 4 | フェーズ数 |

### VDOT別許容差（1サイクルあたり）
現在のVDOTに応じて、1サイクルで達成可能なVDOT向上幅を自動調整します。

| 現在のVDOT | 許容VDOT差 | 対象レベル |
|:-----------|:-----------|:-----------|
| 〜40 | 4.0 | 初心者 |
| 40〜50 | 3.0 | 中級者 |
| 50〜55 | 2.5 | 上級者 |
| 55〜60 | 2.0 | エリート |
| 60以上 | 1.5 | トップエリート |

### 目標VDOT別の最低トレーニング条件
目標VDOTに応じて、必要な最低条件を自動判定・調整します。

| 目標VDOT | 目標タイム目安 | 最低週間距離 | 最低練習日数 | 最低ポイント練習 |
|:---------|:---------------|:-------------|:-------------|:-----------------|
| 〜40 | サブ4以上 | 40km | 3日 | 1回 |
| 40〜45 | サブ3:40 | 50km | 4日 | 1回 |
| 45〜50 | サブ3:20 | 60km | 4日 | 2回 |
| 50〜55 | サブ3:00 | 80km | 5日 | 2回 |
| 55〜60 | サブ2:45 | 100km | 5日 | 2回 |
| 60以上 | サブ2:35以下 | 120km | 6日 | 3回 |

**自動調整機能**: 入力が最低条件を満たさない場合、自動的に最低条件に調整してトレーニング計画を生成します。

---

## 📊 VDOT計算ロジック

### 入力
- 現在のマラソンベストタイム（時:分:秒）
- 目標タイム（時:分:秒）

### 処理
1. タイムを秒に変換
2. `vdot_list.csv`から該当するVDOT値を線形補間で算出
3. 目標VDOTとの差を計算
4. 現在VDOTに応じた許容差を確認

### VDOT差が許容範囲を超える場合
- 中間目標VDOT（現在VDOT + 許容差）を自動設定
- 2段階でのトレーニングを推奨

---

## 📅 トレーニング期間計算

1. レース日までの週数を計算
2. **12週以上**: その週数をそのまま使用
3. **12週未満**: 12週間の計画を生成し、開始日をレース日から12週前に設定（過去の日付になる）

---

## 🤖 Gemini API連携

### 使用モデル
**gemini-3-flash-preview** - 高度な推論能力を持つ最新モデル

### プロンプト設計方針
- シンプルで本質的な指示のみ
- ユーザー要望を最優先で反映
- 出力フォーマットは例示で伝達
- 過度な禁止事項リストを排除

### 出力構成（7セクション）
1. はじめに（挨拶、走力を褒め、計画のポイント）
2. 基本情報
3. VDOTとペースの説明
4. 4フェーズ構成の概要
5. 週間トレーニング計画（Markdown表形式）
6. 注意事項（ユーザー固有の内容含む5項目）
7. コーチからのメッセージ

---

## 🖥️ UI仕様

### 入力フォーム
- 週間走行距離: 数値入力（10〜250km）
- 練習日数: セレクトボックス（1〜7日）
- ポイント練習: セレクトボックス（練習日数に連動）

### 結果表示
- VDOT表示コンポーネント（青色グラデーション）
- トレーニング条件自動調整警告（オレンジ）
- 目標適切メッセージ（緑）
- 入力内容確認エクスパンダー

---

## 🔐 セキュリティ

- APIキーは`.streamlit/secrets.toml`または環境変数で管理
- `.gitignore`でGit管理から除外
- Streamlit CloudではSecrets機能を使用

---

## 🧪 テスト

```bash
python3 -m pytest tests/ -v
```

22件のユニットテスト実装済み。

---

## 🚀 ローカル開発

### 起動コマンド
```bash
cd /Users/yasuchin/apps/ai-marathon-coach/ai-marathon-coach
python3 -m streamlit run app.py
```

ブラウザで http://localhost:8501 にアクセス。

---

*AIマラソンコーチ v1.0.0*

## 4. 外部連携機能 (New v1.4.0)

### 4.1 URLパラメータによる自動入力
VDOT計算機などの外部ツールから、クエリパラメータ経由でフォームの初期値を設定できます。

**パラメータ仕様 (全て任意):**
| パラメータ名 | 説明 | 型 | デフォルト値 |
|:---|:---|:---|:---|
| `best_h` | 現在のベストタイム (時間) | int | 4 |
| `best_m` | 現在のベストタイム (分) | int | 0 |
| `best_s` | 現在のベストタイム (秒) | int | 0 |
| `target_h` | 目標タイム (時間) | int | 3 |
| `target_m` | 目標タイム (分) | int | 30 |
| `target_s` | 目標タイム (秒) | int | 0 |

**使用例:**
`https://app-url/?best_h=3&best_m=30&target_h=3&target_m=0`
（未指定のパラメータはデフォルト値が使用されます）

### 4.2 iframe埋め込み時の注意
`akirun.net` 等の親ページにiframeで埋め込む場合、親ページのURLパラメータは自動的にiframeに引き継がれません。
親ページ側でJavaScriptを使用してパラメータをiframeのsrcに転送する実装が必要です。
詳細: **LP (akirun.net) 用パラメータ転送実装ガイド** を参照してください。
